{% extends "base.html" %}

{% block title %}Namma Cricket - Admin Dashboard{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Add Player Form -->
    <div class="card player-form">
        <div class="card-header">
            <h2 class="card-title">🏏 Add New Player</h2>
        </div>
        <form action="/add_player" method="POST" enctype="multipart/form-data">
            <div class="form-row">
                <input type="text" name="name" class="form-control" placeholder="Player Name" required>
                <select name="type" class="form-control" required>
                    <option value="">Select Role</option>
                    <option value="Batsman">Batsman</option>
                    <option value="Bowler">Bowler</option>
                    <option value="All-Rounder">All-Rounder</option>
                    <option value="Wicket-Keeper">Wicket-Keeper</option>
                </select>
            </div>
            <div class="form-row">
                <input type="number" name="runs" class="form-control" placeholder="Total Runs" min="0">
                <input type="number" name="wickets" class="form-control" placeholder="Total Wickets" min="0">
            </div>
            <div class="form-row">
                <input type="number" name="strike_rate" class="form-control" placeholder="Strike Rate" step="0.01" min="0">
                <input type="number" name="average" class="form-control" placeholder="Batting Average" step="0.01" min="0">
            </div>
            <div class="form-row">
                <input type="text" name="batting_type" class="form-control" placeholder="Batting Type (e.g., Right-handed)">
                <input type="text" name="bowling_type" class="form-control" placeholder="Bowling Type (e.g., Fast, Spin)">
            </div>
            <div class="file-input">
                <input type="file" name="image" id="playerImage" accept="image/*">
                <label for="playerImage" class="file-input-label">
                    📸 Upload Player Image
                </label>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 15px;">
                ➕ Add Player to Auction
            </button>
        </form>
    </div>

    <!-- Current Auction -->
    <div class="card auction-area">
        <div class="card-header">
            <h2 class="card-title">🎯 Live Auction</h2>
            <div class="live-indicator">
                🔴 LIVE
            </div>
        </div>
        
        <div id="currentPlayerDisplay" class="current-player-display">
            <div id="noAuctionMessage" style="color: rgba(255,255,255,0.6); font-size: 1.2rem;">
                No player selected for auction
            </div>
        </div>
        
        <div class="current-bid-display" id="currentBidDisplay">
            Current Bid: ₹25L
        </div>
        
        <div class="timer-display" id="timerDisplay">50</div>
        
        <div class="auction-controls">
            <button class="btn btn-success" onclick="markSold()">✅ Mark Sold</button>
            <button class="btn btn-danger" onclick="markUnsold()">❌ Mark Unsold</button>
            <button class="btn btn-warning" onclick="chooseNextPlayer()">🎲 Next Player</button>
        </div>
        
        <div class="card" style="margin-top: 20px;">
            <div class="card-header">
                <h3 class="card-title">📊 Bidding Log</h3>
            </div>
            <div class="bidding-log" id="biddingLog">
                <div style="color: rgba(255,255,255,0.6); text-align: center; padding: 20px;">
                    No bids yet
                </div>
            </div>
        </div>
    </div>

    <!-- Players List -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">👥 Available Players ({{ players|length }})</h2>
        </div>
        <div class="players-grid" id="playersGrid">
            {% for player in players %}
            <div class="player-card">
                {% if player.image %}
                    <img src="/uploads/{{ player.image }}" alt="{{ player.name }}" class="player-card-image">
                {% else %}
                    <div class="player-card-image" style="background: var(--primary-green); display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                        🏏
                    </div>
                {% endif %}
                <h4 style="color: var(--bright-green); margin-bottom: 5px;">{{ player.name }}</h4>
                <p style="color: var(--gold); font-weight: 600;">{{ player.type }}</p>
                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.8);">
                    <p>Runs: {{ player.runs or 'N/A' }} | Wickets: {{ player.wickets or 'N/A' }}</p>
                    <p>Avg: {{ player.average or 'N/A' }} | SR: {{ player.strike_rate or 'N/A' }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Sold Players -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">✅ Sold Players ({{ sold_players|length }})</h2>
        </div>
        <div class="players-grid" id="soldPlayersGrid">
            {% for player in sold_players %}
            <div class="player-card" style="border-left: 4px solid var(--primary-green);">
                {% if player.image %}
                    <img src="/uploads/{{ player.image }}" alt="{{ player.name }}" class="player-card-image">
                {% else %}
                    <div class="player-card-image" style="background: var(--primary-green); display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                        🏏
                    </div>
                {% endif %}
                <h4 style="color: var(--bright-green);">{{ player.name }}</h4>
                <p style="color: var(--gold);">{{ player.type }}</p>
                <p style="color: var(--white); font-weight: 700;">₹{{ player.sold_price }}L</p>
                <p style="color: rgba(255,255,255,0.8);">Winner: {{ player.winner }}</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Unsold Players -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">❌ Unsold Players ({{ unsold_players|length }})</h2>
        </div>
        <div class="players-grid" id="unsoldPlayersGrid">
            {% for player in unsold_players %}
            <div class="player-card" style="border-left: 4px solid var(--red-highlight);">
                {% if player.image %}
                    <img src="/uploads/{{ player.image }}" alt="{{ player.name }}" class="player-card-image">
                {% else %}
                    <div class="player-card-image" style="background: var(--red-highlight); display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                        🏏
                    </div>
                {% endif %}
                <h4 style="color: var(--red-highlight);">{{ player.name }}</h4>
                <p style="color: var(--gold);">{{ player.type }}</p>
                <p style="color: rgba(255,255,255,0.6);">Unsold</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Bidders Capital -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">💰 Bidders Capital</h2>
        </div>
        <div id="biddersCapital">
            {% for bidder_name, bidder_info in bidders.items() %}
            <div class="purchased-player-item">
                <div class="purchased-player-info">
                    <h4>{{ bidder_name }}</h4>
                    <p class="purchased-player-price">₹{{ bidder_info.capital }}L remaining</p>
                    <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                        Players: {{ bidder_info.purchased_players|length }}
                    </p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
const socket = io();
let timer;
let timeLeft = 50;

function startTimer() {
    if (timer) clearInterval(timer);
    timeLeft = 50;
    updateTimerDisplay();
    
    timer = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        
        if (timeLeft <= 0) {
            clearInterval(timer);
            socket.emit('check_timer');
        }
    }, 1000);
}

function updateTimerDisplay() {
    const timerElement = document.getElementById('timerDisplay');
    timerElement.textContent = timeLeft;
    
    // Change color based on time left
    if (timeLeft <= 10) {
        timerElement.style.color = 'var(--red-highlight)';
        timerElement.style.animation = 'timerPulse 0.5s ease-in-out infinite';
    } else if (timeLeft <= 20) {
        timerElement.style.color = 'var(--gold)';
    } else {
        timerElement.style.color = 'var(--bright-green)';
        timerElement.style.animation = 'timerPulse 1s ease-in-out infinite';
    }
}

function markSold() {
    socket.emit('mark_sold');
}

function markUnsold() {
    socket.emit('mark_unsold');
}

function chooseNextPlayer() {
    fetch('/start_auction', { method: 'POST' })
        .then(() => {
            startTimer();
        });
}

function displayCurrentPlayer(player) {
    const display = document.getElementById('currentPlayerDisplay');
    const noAuctionMsg = document.getElementById('noAuctionMessage');
    
    if (noAuctionMsg) {
        noAuctionMsg.style.display = 'none';
    }
    
    let html = '';
    if (player.image) {
        html += `<img src="/uploads/${player.image}" alt="${player.name}" class="player-image">`;
    } else {
        html += `<div class="player-image" style="background: var(--primary-green); display: flex; align-items: center; justify-content: center; font-size: 4rem; width: 150px; height: 150px; margin: 0 auto 15px;">🏏</div>`;
    }
    
    html += `<div class="player-name">${player.name}</div>`;
    html += `<div style="color: var(--gold); font-size: 1.2rem; margin-bottom: 15px;">${player.type}</div>`;
    
    html += `<div class="player-stats">`;
    html += `<div class="stat-item"><div class="stat-label">Runs</div><div class="stat-value">${player.runs || 'N/A'}</div></div>`;
    html += `<div class="stat-item"><div class="stat-label">Wickets</div><div class="stat-value">${player.wickets || 'N/A'}</div></div>`;
    html += `<div class="stat-item"><div class="stat-label">Average</div><div class="stat-value">${player.average || 'N/A'}</div></div>`;
    html += `<div class="stat-item"><div class="stat-label">Strike Rate</div><div class="stat-value">${player.strike_rate || 'N/A'}</div></div>`;
    if (player.batting_type) {
        html += `<div class="stat-item"><div class="stat-label">Batting</div><div class="stat-value">${player.batting_type}</div></div>`;
    }
    if (player.bowling_type) {
        html += `<div class="stat-item"><div class="stat-label">Bowling</div><div class="stat-value">${player.bowling_type}</div></div>`;
    }
    html += `</div>`;
    
    display.innerHTML = html;
}

function addBidToLog(bidder, amount) {
    const biddingLog = document.getElementById('biddingLog');
    const bidEntry = document.createElement('div');
    bidEntry.className = 'bid-entry';
    bidEntry.innerHTML = `
        <strong>${bidder}</strong> bid <span style="color: var(--gold);">₹${amount}L</span>
        <span style="float: right; color: rgba(255,255,255,0.6); font-size: 0.9rem;">
            ${new Date().toLocaleTimeString()}
        </span>
    `;
    
    if (biddingLog.firstChild && biddingLog.firstChild.textContent.includes('No bids yet')) {
        biddingLog.innerHTML = '';
    }
    
    biddingLog.insertBefore(bidEntry, biddingLog.firstChild);
}

// Socket event listeners
socket.on('auction_started', (player) => {
    displayCurrentPlayer(player);
    document.getElementById('currentBidDisplay').textContent = `Current Bid: ₹25L`;
    document.getElementById('biddingLog').innerHTML = '<div style="color: rgba(255,255,255,0.6); text-align: center; padding: 20px;">Auction started! Waiting for bids...</div>';
    startTimer();
});

socket.on('new_bid', (data) => {
    document.getElementById('currentBidDisplay').textContent = `Current Bid: ₹${data.amount}L`;
    addBidToLog(data.bidder, data.amount);
    startTimer(); // Reset timer on new bid
});

socket.on('auction_end', (data) => {
    if (timer) clearInterval(timer);
    
    const display = document.getElementById('currentPlayerDisplay');
    const timerDisplay = document.getElementById('timerDisplay');
    const bidDisplay = document.getElementById('currentBidDisplay');
    
    if (data.status === 'sold') {
        display.innerHTML = `
            <div style="color: var(--primary-green); font-size: 2rem; margin-bottom: 20px;">✅ SOLD!</div>
            <div style="font-size: 1.5rem; color: var(--bright-green);">${data.player}</div>
            <div style="font-size: 1.2rem; color: var(--gold); margin-top: 10px;">Winner: ${data.winner}</div>
            <div style="font-size: 1.8rem; color: var(--gold); margin-top: 10px;">₹${data.amount}L</div>
        `;
    } else {
        display.innerHTML = `
            <div style="color: var(--red-highlight); font-size: 2rem; margin-bottom: 20px;">❌ UNSOLD</div>
            <div style="font-size: 1.5rem; color: rgba(255,255,255,0.8);">${data.player}</div>
            <div style="font-size: 1.2rem; color: rgba(255,255,255,0.6); margin-top: 10px;">No bids received</div>
        `;
    }
    
    timerDisplay.textContent = '0';
    timerDisplay.style.color = 'var(--red-highlight)';
    
    // Reset after 3 seconds
    setTimeout(() => {
        display.innerHTML = '<div id="noAuctionMessage" style="color: rgba(255,255,255,0.6); font-size: 1.2rem;">No player selected for auction</div>';
        timerDisplay.textContent = '50';
        timerDisplay.style.color = 'var(--bright-green)';
        bidDisplay.textContent = 'Current Bid: ₹25L';
    }, 3000);
});

socket.on('admin_update', (data) => {
    // Update players grid
    updatePlayersGrid(data.players || []);
    updateSoldPlayersGrid(data.sold_players || []);
    updateUnsoldPlayersGrid(data.unsold_players || []);
    updateBiddersCapital(data.bidders || {});
});

function updatePlayersGrid(players) {
    const grid = document.getElementById('playersGrid');
    grid.innerHTML = '';
    
    players.forEach(player => {
        const playerCard = document.createElement('div');
        playerCard.className = 'player-card';
        
        let imageHtml = '';
        if (player.image) {
            imageHtml = `<img src="/uploads/${player.image}" alt="${player.name}" class="player-card-image">`;
        } else {
            imageHtml = `<div class="player-card-image" style="background: var(--primary-green); display: flex; align-items: center; justify-content: center; font-size: 2rem;">🏏</div>`;
        }
        
        playerCard.innerHTML = `
            ${imageHtml}
            <h4 style="color: var(--bright-green); margin-bottom: 5px;">${player.name}</h4>
            <p style="color: var(--gold); font-weight: 600;">${player.type}</p>
            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.8);">
                <p>Runs: ${player.runs || 'N/A'} | Wickets: ${player.wickets || 'N/A'}</p>
                <p>Avg: ${player.average || 'N/A'} | SR: ${player.strike_rate || 'N/A'}</p>
            </div>
        `;
        
        grid.appendChild(playerCard);
    });
}

function updateSoldPlayersGrid(soldPlayers) {
    const grid = document.getElementById('soldPlayersGrid');
    grid.innerHTML = '';
    
    soldPlayers.forEach(player => {
        const playerCard = document.createElement('div');
        playerCard.className = 'player-card';
        playerCard.style.borderLeft = '4px solid var(--primary-green)';
        
        let imageHtml = '';
        if (player.image) {
            imageHtml = `<img src="/uploads/${player.image}" alt="${player.name}" class="player-card-image">`;
        } else {
            imageHtml = `<div class="player-card-image" style="background: var(--primary-green); display: flex; align-items: center; justify-content: center; font-size: 2rem;">🏏</div>`;
        }
        
        playerCard.innerHTML = `
            ${imageHtml}
            <h4 style="color: var(--bright-green);">${player.name}</h4>
            <p style="color: var(--gold);">${player.type}</p>
            <p style="color: var(--white); font-weight: 700;">₹${player.sold_price}L</p>
            <p style="color: rgba(255,255,255,0.8);">Winner: ${player.winner}</p>
        `;
        
        grid.appendChild(playerCard);
    });
}

function updateUnsoldPlayersGrid(unsoldPlayers) {
    const grid = document.getElementById('unsoldPlayersGrid');
    grid.innerHTML = '';
    
    unsoldPlayers.forEach(player => {
        const playerCard = document.createElement('div');
        playerCard.className = 'player-card';
        playerCard.style.borderLeft = '4px solid var(--red-highlight)';
        
        let imageHtml = '';
        if (player.image) {
            imageHtml = `<img src="/uploads/${player.image}" alt="${player.name}" class="player-card-image">`;
        } else {
            imageHtml = `<div class="player-card-image" style="background: var(--red-highlight); display: flex; align-items: center; justify-content: center; font-size: 2rem;">🏏</div>`;
        }
        
        playerCard.innerHTML = `
            ${imageHtml}
            <h4 style="color: var(--red-highlight);">${player.name}</h4>
            <p style="color: var(--gold);">${player.type}</p>
            <p style="color: rgba(255,255,255,0.6);">Unsold</p>
        `;
        
        grid.appendChild(playerCard);
    });
}

function updateBiddersCapital(bidders) {
    const container = document.getElementById('biddersCapital');
    container.innerHTML = '';
    
    for (const [bidderName, bidderInfo] of Object.entries(bidders)) {
        const bidderItem = document.createElement('div');
        bidderItem.className = 'purchased-player-item';
        
        bidderItem.innerHTML = `
            <div class="purchased-player-info">
                <h4>${bidderName}</h4>
                <p class="purchased-player-price">₹${bidderInfo.capital}L remaining</p>
                <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                    Players: ${bidderInfo.purchased_players ? bidderInfo.purchased_players.length : 0}
                </p>
            </div>
        `;
        
        container.appendChild(bidderItem);
    }
}

// Initialize timer display
updateTimerDisplay();
</script>
{% endblock %}