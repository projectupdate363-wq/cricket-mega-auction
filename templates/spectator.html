{% extends "base.html" %}

{% block title %}Namma Cricket - Live Spectator View{% endblock %}

{% block content %}
<div class="spectator-container">
    <div class="bidder-header">
        <h1 class="bidder-name">üèè NAMMA CRICKET LIVE</h1>
        <div class="live-indicator">
            üî¥ LIVE BROADCAST
        </div>
        <p style="text-align: center; color: rgba(255,255,255,0.8); margin-top: 10px;">
            Welcome to the live cricket auction! Watch as teams bid for their favorite players.
        </p>
    </div>

    <div class="card" style="max-width: 800px; margin: 0 auto;">
        <div class="card-header">
            <h2 class="card-title">üéØ Live Auction</h2>
            <div class="live-indicator">
                üì∫ SPECTATOR MODE
            </div>
        </div>
        
        <div id="currentPlayerDisplay" class="current-player-display">
            <div id="noAuctionMessage" style="color: rgba(255,255,255,0.6); font-size: 1.2rem; text-align: center;">
                üèè Waiting for auction to start...
            </div>
        </div>
        
        <div class="current-bid-display" id="currentBidDisplay">
            Current Bid: ‚Çπ25L
        </div>
        
        <div class="timer-display" id="timerDisplay">50</div>
        
        <div id="auctionResult" style="display: none; text-align: center; margin-top: 20px; font-size: 1.2rem;"></div>
        
        <div class="card" style="margin-top: 20px;">
            <div class="card-header">
                <h3 class="card-title">üìä Live Bidding Activity</h3>
            </div>
            <div class="bidding-log" id="biddingLog">
                <div style="color: rgba(255,255,255,0.6); text-align: center; padding: 20px;">
                    üèè No auction activity yet
                </div>
            </div>
        </div>
    </div>

    <!-- Auction Statistics -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">‚úÖ Recently Sold</h3>
            </div>
            <div id="recentlySold">
                {% if sold_players %}
                    {% for player in sold_players[-5:] %}
                    <div class="purchased-player-item">
                        {% if player.image %}
                            <img src="/uploads/{{ player.image }}" alt="{{ player.name }}" class="purchased-player-image">
                        {% else %}
                            <div class="purchased-player-image" style="background: var(--primary-green); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üèè</div>
                        {% endif %}
                        <div class="purchased-player-info">
                            <h4>{{ player.name }}</h4>
                            <p style="color: var(--gold); margin-bottom: 5px;">{{ player.type }}</p>
                            <p class="purchased-player-price">‚Çπ{{ player.sold_price }}L</p>
                            <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">{{ player.winner }}</p>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div style="text-align: center; color: rgba(255,255,255,0.6); padding: 20px;">
                        No players sold yet
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üìà Auction Stats</h3>
            </div>
            <div style="padding: 20px;">
                <div class="stat-item" style="margin-bottom: 15px;">
                    <div class="stat-label">Total Players Sold</div>
                    <div class="stat-value" id="totalSold">{{ sold_players|length }}</div>
                </div>
                <div class="stat-item" style="margin-bottom: 15px;">
                    <div class="stat-label">Total Money Spent</div>
                    <div class="stat-value" id="totalSpent">
                        ‚Çπ{% set total = 0 %}{% for player in sold_players %}{% set total = total + player.sold_price %}{% endfor %}{{ total }}L
                    </div>
                </div>
                <div class="stat-item" style="margin-bottom: 15px;">
                    <div class="stat-label">Highest Sale</div>
                    <div class="stat-value" id="highestSale">
                        {% if sold_players %}
                            ‚Çπ{{ sold_players | map(attribute='sold_price') | max }}L
                        {% else %}
                            ‚Çπ0L
                        {% endif %}
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Active Bidders</div>
                    <div class="stat-value" id="activeBidders">{{ bidders|length if bidders else 0 }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const socket = io();
let timerInterval;
let timeLeft = 50;

function updateTimerDisplay() {
    const timerElement = document.getElementById('timerDisplay');
    timerElement.textContent = timeLeft;
    
    // Change color based on time left
    if (timeLeft <= 10) {
        timerElement.style.color = 'var(--red-highlight)';
        timerElement.style.animation = 'timerPulse 0.5s ease-in-out infinite';
    } else if (timeLeft <= 20) {
        timerElement.style.color = 'var(--gold)';
    } else {
        timerElement.style.color = 'var(--bright-green)';
        timerElement.style.animation = 'timerPulse 1s ease-in-out infinite';
    }
}

function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    timeLeft = 50;
    updateTimerDisplay();
    
    timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
        }
    }, 1000);
}

function displayCurrentPlayer(player) {
    const display = document.getElementById('currentPlayerDisplay');
    const noAuctionMsg = document.getElementById('noAuctionMessage');
    const auctionResult = document.getElementById('auctionResult');
    
    if (noAuctionMsg) {
        noAuctionMsg.style.display = 'none';
    }
    
    auctionResult.style.display = 'none';
    
    let html = '';
    if (player.image) {
        html += `<img src="/uploads/${player.image}" alt="${player.name}" class="player-image">`;
    } else {
        html += `<div class="player-image" style="background: var(--primary-green); display: flex; align-items: center; justify-content: center; font-size: 4rem; width: 150px; height: 150px; margin: 0 auto 15px;">üèè</div>`;
    }
    
    html += `<div class="player-name">${player.name}</div>`;
    html += `<div style="color: var(--gold); font-size: 1.2rem; margin-bottom: 15px;">${player.type}</div>`;
    
    html += `<div class="player-stats">`;
    html += `<div class="stat-item"><div class="stat-label">Runs</div><div class="stat-value">${player.runs || 'N/A'}</div></div>`;
    html += `<div class="stat-item"><div class="stat-label">Wickets</div><div class="stat-value">${player.wickets || 'N/A'}</div></div>`;
    html += `<div class="stat-item"><div class="stat-label">Average</div><div class="stat-value">${player.average || 'N/A'}</div></div>`;
    html += `<div class="stat-item"><div class="stat-label">Strike Rate</div><div class="stat-value">${player.strike_rate || 'N/A'}</div></div>`;
    if (player.batting_type) {
        html += `<div class="stat-item"><div class="stat-label">Batting</div><div class="stat-value">${player.batting_type}</div></div>`;
    }
    if (player.bowling_type) {
        html += `<div class="stat-item"><div class="stat-label">Bowling</div><div class="stat-value">${player.bowling_type}</div></div>`;
    }
    html += `</div>`;
    
    display.innerHTML = html;
}

function addBidToLog(bidder, amount) {
    const biddingLog = document.getElementById('biddingLog');
    const bidEntry = document.createElement('div');
    bidEntry.className = 'bid-entry';
    bidEntry.innerHTML = `
        <strong>${bidder}</strong> bid <span style="color: var(--gold);">‚Çπ${amount}L</span>
        <span style="float: right; color: rgba(255,255,255,0.6); font-size: 0.9rem;">
            ${new Date().toLocaleTimeString()}
        </span>
    `;
    
    if (biddingLog.firstChild && biddingLog.firstChild.textContent.includes('No auction activity yet')) {
        biddingLog.innerHTML = '';
    }
    
    biddingLog.insertBefore(bidEntry, biddingLog.firstChild);
}

function addToRecentlySold(player) {
    const recentlySold = document.getElementById('recentlySold');
    
    // Remove "no players sold" message if it exists
    const noPlayersMsg = recentlySold.querySelector('div[style*="text-align: center"]');
    if (noPlayersMsg) {
        noPlayersMsg.remove();
    }
    
    const playerItem = document.createElement('div');
    playerItem.className = 'purchased-player-item';
    
    let imageHtml = '';
    if (player.image) {
        imageHtml = `<img src="/uploads/${player.image}" alt="${player.name}" class="purchased-player-image">`;
    } else {
        imageHtml = `<div class="purchased-player-image" style="background: var(--primary-green); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üèè</div>`;
    }
    
    playerItem.innerHTML = `
        ${imageHtml}
        <div class="purchased-player-info">
            <h4>${player.name}</h4>
            <p style="color: var(--gold); margin-bottom: 5px;">${player.type || 'Player'}</p>
            <p class="purchased-player-price">‚Çπ${player.sold_price}L</p>
            <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">${player.winner}</p>
        </div>
    `;
    
    recentlySold.insertBefore(playerItem, recentlySold.firstChild);
    
    // Keep only the last 5 items
    while (recentlySold.children.length > 5) {
        recentlySold.removeChild(recentlySold.lastChild);
    }
}

// Socket event listeners
socket.on('auction_started', (player) => {
    displayCurrentPlayer(player);
    document.getElementById('currentBidDisplay').textContent = `Current Bid: ‚Çπ25L`;
    document.getElementById('biddingLog').innerHTML = '<div style="color: rgba(255,255,255,0.6); text-align: center; padding: 20px;">üèè Auction started! Waiting for bids...</div>';
    startTimer();
});

socket.on('new_bid', (data) => {
    document.getElementById('currentBidDisplay').textContent = `Current Bid: ‚Çπ${data.amount}L`;
    addBidToLog(data.bidder, data.amount);
    startTimer(); // Reset timer on new bid
});

socket.on('auction_end', (data) => {
    if (timerInterval) clearInterval(timerInterval);
    
    const display = document.getElementById('currentPlayerDisplay');
    const auctionResult = document.getElementById('auctionResult');
    const timerDisplay = document.getElementById('timerDisplay');
    
    auctionResult.style.display = 'block';
    
    if (data.status === 'sold') {
        auctionResult.innerHTML = `
            <div style="color: var(--primary-green); font-size: 1.5rem; margin-bottom: 10px;">‚úÖ SOLD!</div>
            <div style="color: var(--bright-green); font-size: 1.2rem;">${data.player}</div>
            <div style="color: var(--gold); margin-top: 10px;">Winner: ${data.winner} for ‚Çπ${data.amount}L</div>
        `;
        
        // Add to recently sold
        addToRecentlySold({
            name: data.player,
            sold_price: data.amount,
            winner: data.winner,
            image: null // You might want to pass the image data
        });
        
        // Update stats
        const totalSold = document.getElementById('totalSold');
        totalSold.textContent = parseInt(totalSold.textContent) + 1;
        
    } else {
        auctionResult.innerHTML = `
            <div style="color: var(--red-highlight); font-size: 1.5rem; margin-bottom: 10px;">‚ùå UNSOLD</div>
            <div style="color: rgba(255,255,255,0.8); font-size: 1.2rem;">${data.player}</div>
            <div style="color: rgba(255,255,255,0.6); margin-top: 10px;">No bids received</div>
        `;
    }
    
    timerDisplay.textContent = '0';
    timerDisplay.style.color = 'var(--red-highlight)';
    
    // Reset after 3 seconds
    setTimeout(() => {
        display.innerHTML = '<div id="noAuctionMessage" style="color: rgba(255,255,255,0.6); font-size: 1.2rem; text-align: center;">üèè Waiting for next auction...</div>';
        timerDisplay.textContent = '50';
        timerDisplay.style.color = 'var(--bright-green)';
        document.getElementById('currentBidDisplay').textContent = 'Current Bid: ‚Çπ25L';
        auctionResult.style.display = 'none';
    }, 3000);
});

// Initialize timer display
updateTimerDisplay();
</script>
{% endblock %}